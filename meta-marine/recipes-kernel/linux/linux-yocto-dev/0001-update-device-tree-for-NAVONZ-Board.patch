From 4a634edd08273c60c3444758ffc57d08dd9d1897 Mon Sep 17 00:00:00 2001
From: Trinh Viet Quang <trinh.quang@cavliwireless.com>
Date: Sat, 23 Aug 2025 00:20:38 +0700
Subject: [PATCH 1/5] update device tree for NAVONZ Board

Upstream-Status: Inappropriate [oe specific]

Signed-off-by: Trinh Viet Quang <trinh.quang@cavliwireless.com>
---
 .../boot/dts/rockchip/rk3588-nanopc-t6.dts    |  11 +-
 .../boot/dts/rockchip/rk3588-nanopc-t6.dtsi   | 164 +++++++++++++++---
 2 files changed, 147 insertions(+), 28 deletions(-)

diff --git a/arch/arm64/boot/dts/rockchip/rk3588-nanopc-t6.dts b/arch/arm64/boot/dts/rockchip/rk3588-nanopc-t6.dts
index 40290a81bb9d..b0c4e53e92a0 100644
--- a/arch/arm64/boot/dts/rockchip/rk3588-nanopc-t6.dts
+++ b/arch/arm64/boot/dts/rockchip/rk3588-nanopc-t6.dts
@@ -14,10 +14,17 @@ / {
 	model = "FriendlyElec NanoPC-T6";
 	compatible = "friendlyarm,nanopc-t6", "rockchip,rk3588";
 
+	//===============================================
+	// ADDED: 2025-08-22
+	// AUTHOR: QUANG TV
+	// CHAGED:
+	// - ADD: USB 2.0 host power enable
+	// - Using GPIO4 RK_RC3 to control the power enable
+	//===============================================
 	vdd_4g_3v3: regulator-vdd-4g-3v3 {
 		compatible = "regulator-fixed";
 		enable-active-high;
-		gpio = <&gpio4 RK_PC6 GPIO_ACTIVE_HIGH>;
+		gpio = <&gpio4 RK_PC3 GPIO_ACTIVE_HIGH>;
 		pinctrl-names = "default";
 		pinctrl-0 = <&pin_4g_lte_pwren>;
 		regulator-name = "vdd_4g_3v3";
@@ -30,7 +37,7 @@ vdd_4g_3v3: regulator-vdd-4g-3v3 {
 &pinctrl {
 	usb {
 		pin_4g_lte_pwren: 4g-lte-pwren {
-			rockchip,pins = <4 RK_PC6 RK_FUNC_GPIO &pcfg_pull_none>;
+			rockchip,pins = <4 RK_PC3 RK_FUNC_GPIO &pcfg_pull_none>;
 		};
 	};
 };
diff --git a/arch/arm64/boot/dts/rockchip/rk3588-nanopc-t6.dtsi b/arch/arm64/boot/dts/rockchip/rk3588-nanopc-t6.dtsi
index 3d8b6f0c5541..79c667a85d18 100644
--- a/arch/arm64/boot/dts/rockchip/rk3588-nanopc-t6.dtsi
+++ b/arch/arm64/boot/dts/rockchip/rk3588-nanopc-t6.dtsi
@@ -21,6 +21,8 @@ / {
 	aliases {
 		mmc0 = &sdhci;
 		mmc1 = &sdmmc;
+		ethernet0 = &gmac0;
+		ethernet1 = &gmac1;
 	};
 
 	adc-keys-0 {
@@ -192,22 +194,39 @@ vbus5v0_usb: regulator-vbus5v0-usb {
 		vin-supply = <&vcc5v0_sys>;
 	};
 
-	vcc3v3_pcie2x1l0: regulator-vcc3v3-pcie2x1l0 {
+	vcc3v3_pcie2x1l1: regulator-vcc3v3-pcie2x1l1 {
 		compatible = "regulator-fixed";
 		enable-active-high;
-		gpio = <&gpio4 RK_PC2 GPIO_ACTIVE_HIGH>;
+		gpio = <&gpio0 RK_PC6 GPIO_ACTIVE_HIGH>;
 		pinctrl-names = "default";
 		pinctrl-0 = <&pcie_m2_1_pwren>;
-		regulator-name = "vcc3v3_pcie2x1l0";
+		regulator-name = "vcc3v3_pcie2x1l1";
+		regulator-min-microvolt = <3300000>;
+		regulator-max-microvolt = <3300000>;
+		vin-supply = <&vcc5v0_sys>;
+	};
+
+	vcc3v3_pcie2x1l2: regulator-vcc3v3-pcie2x1l2 {
+		compatible = "regulator-fixed";
+		enable-active-high;
+		gpio = <&gpio4 RK_PC2 GPIO_ACTIVE_HIGH>;
+		pinctrl-names = "default";
+		pinctrl-0 = <&pcie_m2_2_pwren>;
+		regulator-name = "vcc3v3_pcie2x1l2";
 		regulator-min-microvolt = <3300000>;
 		regulator-max-microvolt = <3300000>;
 		vin-supply = <&vcc5v0_sys>;
 	};
 
+	//===============================================
+	// ADDED: 2025-08-22
+	// AUTHOR: QUANG TV
+	// CHAGED: Uing GPIO4 RK_PC6 to control the power enable
+	//================================================
 	vcc3v3_pcie30: regulator-vcc3v3-pcie30 {
 		compatible = "regulator-fixed";
 		enable-active-high;
-		gpios = <&gpio2 RK_PC5 GPIO_ACTIVE_HIGH>;
+		gpios = <&gpio4 RK_PC6 GPIO_ACTIVE_HIGH>;
 		pinctrl-names = "default";
 		pinctrl-0 = <&pcie_m2_0_pwren>;
 		regulator-name = "vcc3v3_pcie30";
@@ -463,9 +482,17 @@ regulator-state-mem {
 &i2c6 {
 	status = "okay";
 
-	usbc0: usb-typec@22 {
+	//===============================================
+	// This is the FUSB302 Type-C controller
+	// ADDED: 2025-08-22
+	// AUTHOR: QUANG TV
+	// CHAGED:
+	// - I2C address from 0x22 to 0x44
+	// - REMOVE: RTC in i2c6 and added to i2c8
+	//===============================================
+	usbc0: usb-typec@44 {
 		compatible = "fcs,fusb302";
-		reg = <0x22>;
+		reg = <0x44>;
 		interrupt-parent = <&gpio0>;
 		interrupts = <RK_PD3 IRQ_TYPE_LEVEL_LOW>;
 		pinctrl-names = "default";
@@ -513,18 +540,6 @@ usbc0_sbu: endpoint {
 			};
 		};
 	};
-
-	hym8563: rtc@51 {
-		compatible = "haoyu,hym8563";
-		reg = <0x51>;
-		#clock-cells = <0>;
-		clock-output-names = "hym8563";
-		pinctrl-names = "default";
-		pinctrl-0 = <&hym8563_int>;
-		interrupt-parent = <&gpio0>;
-		interrupts = <RK_PB0 IRQ_TYPE_LEVEL_LOW>;
-		wakeup-source;
-	};
 };
 
 &i2c7 {
@@ -532,6 +547,7 @@ &i2c7 {
 	status = "okay";
 
 	rt5616: codec@1b {
+		status = "disabled";
 		compatible = "realtek,rt5616";
 		reg = <0x1b>;
 		clocks = <&cru I2S0_8CH_MCLKOUT>;
@@ -547,11 +563,46 @@ rt5616_p0_0: endpoint {
 		};
 	};
 
+	es8316: audio-codec@10 {
+		status = "okay";
+		compatible = "everest,es8316";
+		reg = <0x10>;
+		assigned-clocks = <&cru I2S0_8CH_MCLKOUT>;
+		assigned-clock-rates = <12288000>;
+		clocks = <&cru I2S0_8CH_MCLKOUT>;
+		clock-names = "mclk";
+		#sound-dai-cells = <0>;
+
+		port {
+			es8316_p0_0: endpoint {
+				remote-endpoint = <&i2s0_8ch_p0_0>;
+			};
+		};
+	};
 	/* connected with MIPI-CSI1 */
 };
 
 &i2c8 {
+	//===============================================
+	// ADDED: 2025-08-22
+	// AUTHOR: QUANG TV
+	// CHAGED:
+	// - ADD: RTC
+	//===============================================
 	pinctrl-0 = <&i2c8m2_xfer>;
+	status = "okay";
+	hym8563: rtc@51 {
+		status = "okay";
+		compatible = "haoyu,hym8563";
+		reg = <0x51>;
+		#clock-cells = <0>;
+		clock-output-names = "hym8563";
+		pinctrl-names = "default";
+		pinctrl-0 = <&hym8563_int>;
+		interrupt-parent = <&gpio0>;
+		interrupts = <RK_PB0 IRQ_TYPE_LEVEL_LOW>;
+		wakeup-source;
+	};
 };
 
 &i2s0_8ch {
@@ -567,7 +618,7 @@ i2s0_8ch_p0: port {
 		i2s0_8ch_p0_0: endpoint {
 			dai-format = "i2s";
 			mclk-fs = <256>;
-			remote-endpoint = <&rt5616_p0_0>;
+			remote-endpoint = <&es8316_p0_0>;
 		};
 	};
 };
@@ -581,6 +632,15 @@ &i2s6_8ch {
 };
 
 &pcie2x1l0 {
+	//===============================================
+	// ADDED: 2025-08-22
+	// AUTHOR: QUANG TV
+	// CHAGED:
+	// - ADD: PCIe M.2 2.5G Ethernet
+	// - Using GPIO4 RK_PB3 to 
+	// control the power enable for lane 0
+	// - Lane 0 is used for M.2 2.5G Ethernet
+	//===============================================
 	reset-gpios = <&gpio4 RK_PB3 GPIO_ACTIVE_HIGH>;
 	vpcie3v3-supply = <&vcc_3v3_pcie20>;
 	pinctrl-names = "default";
@@ -589,16 +649,34 @@ &pcie2x1l0 {
 };
 
 &pcie2x1l1 {
-	reset-gpios = <&gpio4 RK_PA2 GPIO_ACTIVE_HIGH>;
-	vpcie3v3-supply = <&vcc3v3_pcie2x1l0>;
+	//===============================================
+	// ADDED: 2025-08-22
+	// AUTHOR: QUANG TV
+	// CHAGED:
+	// - ADD: PCIe M.2 4G LTE
+	// - Using GPIO4 RK_PA2 instead of GPIO3 RK_PD1 to
+	// control the power enable for lane 1
+	// - Lane 1 is used for NVMe M.2 Solid State Drive
+	//===============================================
+	reset-gpios = <&gpio3 RK_PD1 GPIO_ACTIVE_HIGH>;
+	vpcie3v3-supply = <&vcc3v3_pcie2x1l1>;
 	pinctrl-names = "default";
 	pinctrl-0 = <&pcie2_1_rst>;
 	status = "okay";
 };
 
 &pcie2x1l2 {
-	reset-gpios = <&gpio4 RK_PA4 GPIO_ACTIVE_HIGH>;
-	vpcie3v3-supply = <&vcc_3v3_pcie20>;
+	//===============================================
+	// ADDED: 2025-08-22
+	// AUTHOR: QUANG TV
+	// CHAGED:
+	// - ADD: PCIe M.2 2.5G Ethernet
+	// - Using GPIO4 RK_PA4 instead of RK_PA2 to
+	// control the power enable for lane 2
+	// - Lane 2 is used for wifi/bt module
+	//===============================================
+	reset-gpios = <&gpio4 RK_PA2 GPIO_ACTIVE_HIGH>;
+	vpcie3v3-supply = <&vcc3v3_pcie2x1l2>;
 	pinctrl-names = "default";
 	pinctrl-0 = <&pcie2_2_rst>;
 	status = "okay";
@@ -653,18 +731,22 @@ pcie2_0_rst: pcie2-0-rst {
 		};
 
 		pcie2_1_rst: pcie2-1-rst {
-			rockchip,pins = <4 RK_PA2 RK_FUNC_GPIO &pcfg_pull_none>;
+			rockchip,pins = <3 RK_PD1 RK_FUNC_GPIO &pcfg_pull_none>;
 		};
 
 		pcie2_2_rst: pcie2-2-rst {
-			rockchip,pins = <4 RK_PA4 RK_FUNC_GPIO &pcfg_pull_none>;
+			rockchip,pins = <4 RK_PA2 RK_FUNC_GPIO &pcfg_pull_none>;
 		};
 
 		pcie_m2_0_pwren: pcie-m20-pwren {
-			rockchip,pins = <2 RK_PC5 RK_FUNC_GPIO &pcfg_pull_none>;
+			rockchip,pins = <4 RK_PC6 RK_FUNC_GPIO &pcfg_pull_none>;
 		};
 
 		pcie_m2_1_pwren: pcie-m21-pwren {
+			rockchip,pins = <0 RK_PC6 RK_FUNC_GPIO &pcfg_pull_none>;
+		};
+
+		pcie_m2_2_pwren: pcie-m22-pwren {
 			rockchip,pins = <4 RK_PC2 RK_FUNC_GPIO &pcfg_pull_none>;
 		};
 	};
@@ -1181,3 +1263,33 @@ vp1_out_hdmi1: endpoint@ROCKCHIP_VOP2_EP_HDMI1 {
 		remote-endpoint = <&hdmi1_in_vp1>;
 	};
 };
+
+&gmac0 {
+	clock_in_out = "output";
+	phy-handle = <&rgmii_phy0>;
+	phy-mode = "rgmii-rxid";
+	pinctrl-names = "default";
+	pinctrl-0 = <&gmac0_miim
+		     &gmac0_tx_bus2
+		     &gmac0_rx_bus2
+		     &gmac0_rgmii_clk
+		     &gmac0_rgmii_bus>;
+	tx_delay = <0x45>;
+	rx_delay = <0x4a>;
+	status = "okay";
+};
+
+&gmac1 {
+	clock_in_out = "output";
+	phy-handle = <&rgmii_phy1>;
+	phy-mode = "rgmii-rxid";
+	pinctrl-names = "default";
+	pinctrl-0 = <&gmac1_miim
+		     &gmac1_tx_bus2
+		     &gmac1_rx_bus2
+		     &gmac1_rgmii_clk
+		     &gmac1_rgmii_bus>;
+	tx_delay = <0x42>;
+	rx_delay = <0x4f>;
+	status = "okay";
+};
\ No newline at end of file
-- 
2.43.0

